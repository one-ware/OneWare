<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:viewModels="clr-namespace:OneWare.ChatBot.ViewModels"
             xmlns:avaloniaEdit="https://github.com/avaloniaui/avaloniaedit"
             xmlns:controls="clr-namespace:OneWare.Essentials.Controls;assembly=OneWare.Essentials"
             mc:Ignorable="d"
             x:Class="OneWare.ChatBot.Views.ChatMessageView"
             x:DataType="viewModels:ChatMessageViewModel">

    <UserControl.Styles>

        <!-- Base message bubble -->
        <Style Selector="Border.message">
            <Setter Property="CornerRadius" Value="10" />
            <Setter Property="Padding" Value="14 12" />
            <Setter Property="MaxWidth" Value="640" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="HorizontalAlignment" Value="Left" />
        </Style>

        <!-- User message -->
        <Style Selector="Border.message.user">
            <Setter Property="Background"
                    Value="{DynamicResource ThemeControlMidBrush}" />
            <Setter Property="HorizontalAlignment" Value="Right" />
        </Style>

        <!-- Assistant message -->
        <Style Selector="Border.message.assistant">
            <Setter Property="Background"
                    Value="{DynamicResource ThemeControlLowBrush}" />
        </Style>

        <!-- Streaming indicator -->
        <Style Selector="TextBlock.streaming">
            <Setter Property="Foreground"
                    Value="{DynamicResource ThemeForegroundLowBrush}" />
            <Setter Property="FontSize" Value="11" />
            <Setter Property="FontStyle" Value="Italic" />
            <Setter Property="Margin" Value="2 4 0 0" />
        </Style>

    </UserControl.Styles>

    <Border Classes="message"
            Classes.user="{Binding IsUser}"
            Classes.assistant="{Binding IsAssistant}">

        <StackPanel Spacing="6">

            <!-- Message content -->
            <controls:MarkdownViewer Markdown="{Binding Message}">
                <controls:MarkdownViewer.Styles>

                    <!-- Inline code / editor -->
                    <Style Selector="avaloniaEdit|TextEditor">
                        <Setter Property="FontFamily"
                                Value="{DynamicResource EditorFont}" />
                        <Setter Property="HorizontalScrollBarVisibility"
                                Value="Disabled" />
                        <Setter Property="VerticalScrollBarVisibility"
                                Value="Disabled" />
                        <Setter Property="Background" Value="Transparent" />
                    </Style>

                    <!-- Code blocks -->
                    <Style Selector="Border.CodeBlock">
                        <Setter Property="Margin" Value="4 6" />
                        <Setter Property="Padding" Value="8" />
                        <Setter Property="CornerRadius" Value="6" />
                        <Setter Property="Background"
                                Value="{DynamicResource ThemeBackgroundBrush}" />
                    </Style>

                </controls:MarkdownViewer.Styles>
            </controls:MarkdownViewer>

            <!-- Streaming hint -->
            <TextBlock Classes="streaming"
                       Text="Thinking…"
                       IsVisible="{Binding IsStreaming}" />

        </StackPanel>
    </Border>
</UserControl>