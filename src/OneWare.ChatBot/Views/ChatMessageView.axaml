<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:viewModels="clr-namespace:OneWare.ChatBot.ViewModels"
             xmlns:avaloniaEdit="https://github.com/avaloniaui/avaloniaedit"
             xmlns:controls="clr-namespace:OneWare.Essentials.Controls;assembly=OneWare.Essentials"
             mc:Ignorable="d"
             x:Class="OneWare.ChatBot.Views.ChatMessageView"
             x:DataType="viewModels:ChatMessageViewModel">

    <UserControl.Styles>

        <!-- Base message bubble -->
        <Style Selector="Border.message">
            <Setter Property="CornerRadius" Value="10" />
            <Setter Property="Padding" Value="8 6" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="HorizontalAlignment" Value="Left" />
        </Style>

        <!-- User message -->
        <Style Selector="Border.message.user">
            <Setter Property="Background"
                    Value="{DynamicResource ThemeControlMidBrush}" />
            <Setter Property="HorizontalAlignment" Value="Right" />
        </Style>

        <!-- Assistant message -->
        <Style Selector="Border.message.assistant">
            <Setter Property="Background"
                    Value="{DynamicResource ThemeControlLowBrush}" />
        </Style>

        <!-- Tool message -->
        <Style Selector="Border.message.tool">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="Padding" Value="6 0" />
            <Setter Property="Opacity" Value="0.7" />
            <Setter Property="HorizontalAlignment" Value="Stretch" />
        </Style>

        <!-- Streaming indicator -->
        <Style Selector="TextBlock.streaming">
            <Setter Property="Foreground"
                    Value="{DynamicResource ThemeForegroundLowBrush}" />
            <Setter Property="FontSize" Value="11" />
            <Setter Property="FontStyle" Value="Italic" />
        </Style>

    </UserControl.Styles>

    <Border Classes="message"
            Classes.user="{Binding IsUser}"
            Classes.assistant="{Binding IsAssistant}"
            Classes.tool="{Binding IsToolMessage}">

        <Panel>

            <Grid ColumnDefinitions="*, 10" ColumnSpacing="5" IsVisible="{Binding IsToolMessage}">
                <TextBlock Text="{Binding Message}" TextWrapping="Wrap" />
                <controls:ThreeDotLoader IsVisible="{Binding IsToolRunning}" Grid.Column="1" Height="10" Width="10" VerticalAlignment="Center" />
            </Grid>
            
            <StackPanel Spacing="6" IsVisible="{Binding !IsToolMessage}">
                <!-- Message content -->
                <controls:MarkdownViewer Markdown="{Binding Message}" />

                <!-- Streaming hint -->
                <Grid ColumnDefinitions="Auto, Auto" ColumnSpacing="5" IsVisible="{Binding IsStreaming}">
                    <TextBlock Classes="streaming"
                               Text="Thinking…" />
                
                    <controls:Spinner Grid.Column="1" Width="12" Height="12"></controls:Spinner>
                </Grid>
            </StackPanel>

        </Panel>
    </Border>
</UserControl>